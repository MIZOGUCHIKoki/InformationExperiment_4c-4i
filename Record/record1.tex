\documentclass{jlreq}
\input{preamble.tex}
\usepackage[margin=20truemm,headheight=20pt]{geometry}
\usepackage{fancyhdr,lastpage}
\fancypagestyle{fancy}{
    \fancyhf{}
    \fancyhead[R]{\thepage\ /\ \pageref{LastPage}}
    \fancyhead[C]{作業記録（Group C5）}
    \fancyhead[L]{July 13th, 2023}
}
\pagestyle{fancy}
\begin{document}
\begin{framed}
    \tableofcontents
\end{framed}
\section{Webシステム}
\subsection{HTTP通信}
\newcommand{\apache}{\texttt{Apache}}
\begin{enumerate}
    \item \apache をインストールする．
          \begin{lstlisting}
$ sudo su %\enter%
# apt update %\enter%
# apt install apache2 %\enter%
    \end{lstlisting}
    \item Baisc認証を設定する．IDを\texttt{testuser}，パスワードを\texttt{root00}とする．
          \begin{lstlisting}
# htpasswd -c /etc/apache2/.htpasswd testuser %\enter%
New password: root00 %\enter%
Re-type new password: root00 %\enter%
Adding password for user testuser
\end{lstlisting}
    \item \texttt{/var/www/html/}の下にある\texttt{index.html}の名前を変更し，新しく\texttt{index.html}を作成する．
          \begin{lstlisting}[style=file,caption={\ttfamily /var/www/html/index.html},language=html]
<h1>Group 5C</h1>
<h2>/var/www/html/index.html</h2>
    \end{lstlisting}
    \item \texttt{/var/www/html/basic/}と\texttt{/var/www/html/inside/}に\texttt{index.html}を作成する．
          \begin{lstlisting}[style=file,language=html,caption={\ttfamily /var/www/html/basic/index.html}]
<h1>Group 5C</h1>
<h2>/var/www/html/basic/index.html</h2>
\end{lstlisting}
          \begin{lstlisting}[style=file,language=html,caption={\ttfamily /var/www/html/inside/index.html}]
<h1>Group 5C</h1>
<h2>/var/www/html/inside/index.html</h2>
    \end{lstlisting}
    \item \texttt{/var/www/html/basic/}のディレクトリにBasic認証を適用する．（以下を追記する．）
          \begin{lstlisting}[style=file,caption={\ttfamily /etc/apache2/sites-available/000-default.conf},label={src:basic}]
<Directory /var/www/html/basic>
    AuthType Basic
    AuthUserFile /etc/apache2/.htpasswd
    AuthName "basic auth"
    Satisfy any
    Order deny,allow
    Deny from all
    Require valid-user
</Directory>
\end{lstlisting}
    \item \texttt{/var/www/html/inside/}ディレクトリにIPアドレスによるアクセス制限を設ける．（以下を追記する．）\texttt{192.168.0.161}，\texttt{192.168.0.162}以外からのアクセスを拒否する．
          \begin{lstlisting}[style=file,caption={\ttfamily /etc/apache2/sites-available/000-default.conf},label={src:inside}]
<Directory /var/www/html/inside>
    Order deny,allow
    Deny from all
    Allow from 192.168.0.161
    Allow from 192.168.0.162
</Directory>
    \end{lstlisting}
    \item \apache を再起動する．
          \begin{lstlisting}
# systemctl restart apache2 %\enter%
\end{lstlisting}
\end{enumerate}
\subsection{HTTPS通信と証明書}
\begin{enumerate}
    \item Ubuntu の\apache で\texttt{SSL/TLS}通信をするために必要なモジュールを使用する設定．
          \begin{lstlisting}
# a2emod ssl %\enter%
# a2ensite default-ssl %\enter%
# systemctl restart apache2 %\enter%
\end{lstlisting}
    \item \srcref{src:basic}，\srcref{src:inside}の内容を\texttt{/etc/apache2/sites-available/default-ssl.conf}にも追記する．
    \item 秘密鍵を作成する．
          \begin{lstlisting}
# openssl genrsa -out server.key 2048 %\enter%
\end{lstlisting}
    \item 秘密鍵\texttt{server.key}に対応する証明書署名要求\texttt{CSR}を作成する．
          \begin{lstlisting}
# openssl req -new -key server.key -sha256 -out server.CSR %\enter%
Country Name: JP %\enter%
State or Privience Name: Kochi %\enter%
Locality Name: Kochi-shi %\enter%
Organization Name: Kochi Purefectual Public University Corporation %\enter%
Organization Unit Name: . %\enter%
Common Name: www.c5.exp.info.kochi-tech.ac.jp %\enter%
Email Address: . %\enter%
extra: %\enter% %\enter%
# 
\end{lstlisting}
    \item 作成した証明書をTAに渡す．
    \item 自分の秘密鍵\texttt{server.key}で署名する．証明書ファイルは\texttt{server.crt}．
          \begin{lstlisting}
# openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt %\enter%
\end{lstlisting}
    \item 証明書ファイルを設置する．
          \begin{lstlisting}
# mv server.key /etc/ssl/private/ %\enter%
# mv server.crt /etc/ssl/certs/ %\enter%
\end{lstlisting}
          \begin{lstlisting}[style=file,caption={\ttfamily /etc/apache2/sites-available/default-ssl.conf}]
SSLCertificateFile /etc/ssl/certs/server.crt
SSLCertificateKeyFile /etc/ssl/private/server.key
\end{lstlisting}
    \item 鍵の権限を変更する．
          \begin{lstlisting}
# chown root:root /etc/ssl/certs/server.crt %\enter%
# chmod 644 /etc/ssl/certs/server.crt %\enter%
# chown root:ssl-cert /etc/ssl/private/server.key %\enter%
# chmod 640 /etc/ssl/private/server.key %\enter%
\end{lstlisting}
    \item \apache を再起動する．
\end{enumerate}
\subsection{動的コンテンツの設定}
\begin{enumerate}
    \item \apache でCGIを利用できるようにする．
          \begin{lstlisting}
# a2enmod cgi %\enter%
\end{lstlisting}
          以下のコメントアウトを解除する．
          \begin{lstlisting}[style=file,caption={\ttfamily /etc/apache2/mods-enabled/mime.conf}]
AddHandler cgi-script .cgi
\end{lstlisting}
          \texttt{/var/www/html/cig/}ディレクトリのCGIを許可する．（以下を追記する．）
          \begin{lstlisting}[style=file,caption={\ttfamily /etc/apache2/sites-available/default-ssl.conf}]
<Directory /var/www/html/cgi>
    Options +ExecCGI
</Directory>
\end{lstlisting}
    \item \apache でSSIを利用できるようにする．
          \begin{lstlisting}
# a2enmod include %\enter%
\end{lstlisting}
          以下の2行が有効であることを確認する．
          \begin{lstlisting}[style=file,caption={\ttfamily /etc/apache2/mods-enabled/mime.conf}]
AddType text/html .shtml
AddOutputFilter INCLUDES .shtml
\end{lstlisting}
          \texttt{/var/www/html/ssi/}ディレクトリのSSIを許可する．
          \begin{lstlisting}[style=file,caption={\ttfamily /etc/apache2/sites-available/default-ssl.conf}]
<Directory /var/www/html/ssi>
    Options Includes
</Directory>
\end{lstlisting}
    \item \apache を再起動する．
    \item PHPと\apache のPHP呼び出しモジュールをインストールする．
          \begin{lstlisting}
# apt install php
# apt install libapache2-mod-php
\end{lstlisting}
    \item PHPプログラムを取得する．
          \begin{lstlisting}
# wget ftp://222.229.69.11/00/time.cgi %\enter%
# wget ftp://222.229.69.11/00/time.shtml %\enter%
# wget ftp://222.229.69.11/00/counter.cgi %\enter%
# wget ftp://222.229.69.11/00/time.php
\end{lstlisting}
    \item これらを，適切な場所に配置する．
          \begin{lstlisting}
# mkdir /var/www/html/cgi/ %\enter%
# mv time.cgi /var/www/html/cgi/ %\enter%
# mkdir /var/www/html/ssi %\enter%
# mv time.shtml /var/www/html/ssi/ %\enter%
# mv counter.cgi /var/www/html/cgi/ %\enter%
\end{lstlisting}
    \item \texttt{time.cgi}，\texttt{counter.cgi}に実行権限を与える．
          \begin{lstlisting}
# chmod 755 /var/www/html/cgi/time.cgi %\enter%
# chmod 755 /var/www/html/cgi/counter.cgi %\enter%
\end{lstlisting}
    \item \texttt{counter.cgi}で用いるカウンタファイルを作成する．
          \begin{lstlisting}
# echo "0" > /var/www/html/cgi/count.dat %\enter%
# chmod 644 count.dat %\enter%
# chown www-data:www-data count.dat %\enter%
\end{lstlisting}
\end{enumerate}
\clearpage
\section{データベース・Webシステム}
\subsection{Windowsの端末ソフトウェア}
\begin{enumerate}
    \item \texttt{PuTTY}をインストールする．
    \item \texttt{PuTTY}の文字コードを\texttt{UTF-8}へ変更する．\\
          \texttt{Window → Translation → Remote character set}で\texttt{UTF-8}とする．
    \item SSHでサーバへログインする．
    \item 日本語文字コード，改行コードの変換に使われる\texttt{NKF}をインストールする．
          \begin{lstlisting}
# apt update %\enter%
# apt install nkf %\enter%
\end{lstlisting}
\end{enumerate}
\subsection{MySQLのインストールと文字コードの設定}
\begin{enumerate}
    \item シェルの文字コードを\texttt{UTF-8}に設定する．
          \begin{lstlisting}
$ sudo su %\enter%
# locale-gen ja_JP.UTF-8 %\enter%
\end{lstlisting}
          以下を追記する．
          \begin{lstlisting}[style=file,caption={\ttfamily \~\ /.bashrc}]
export LANG=ja_JP.UTF-8
\end{lstlisting}
    \item MySQLをインストール
          \begin{lstlisting}
# apt install mysql-server %\enter%
\end{lstlisting}
    \item MySQLの文字コードを\texttt{UTF-8}に変更．（以下を追記する．）
          \begin{lstlisting}[style=file,caption={\ttfamily /etc/mysql/conf.d/mysql.cnf}]
default-character-set=utf8
\end{lstlisting}
          \begin{lstlisting}[style=file,caption={\ttfamily /etc/mysql/mysql.conf.d/mysqld.cnf}]
character-set-server=utf8    
\end{lstlisting}
    \item MySQLを再起動する．
          \begin{lstlisting}
# systemctl restart mysql %\enter%
\end{lstlisting}
\end{enumerate}
\subsection{データベースの構築}
\begin{enumerate}
    \item FTPで3つの\texttt{CSV}ファイルを取得する．
          \begin{lstlisting}
ftp 222.229.69.11 %\enter%
    Connected to 222.229.69.11.
    220 mainserver FTP server (Version 6.00LS) ready.
Name (222.229.69.11:exp): ftp %\enter%
    331 Guest login ok, send your email address as password.
Password: %\enter%
ftp> get bunrui.csv %\enter%
ftp> get tanka.csv %\enter%
ftp> get uriage.csv %\enter%
ftp> quite %\enter%
221 Goodbey.
\end{lstlisting}
    \item 取得した\texttt{CSV}ファイルを\texttt{UTF-8}に変換し，Index（1行目）を削除する．
          \begin{lstlisting}
# nkf -w -d bunrui.csv > bunrui-utf8.csv %\enter%
# nkf -w -d tanka.csv > tanka-utf8.csv %\enter%
# nkf -w -d uriage.csv > uriage-utf8.csv %\enter%
\end{lstlisting}
    \item サーバ側でのローカルファイルからのデータ一括入力の可否を制御する変数\texttt{local infile}を\texttt{1}（可）に変更する．
          \begin{lstlisting}
# mysql -u root %\enter%
mysql> set persist local_infile=1; %\enter%
\end{lstlisting}
    \item ラーメン屋売上データベースを作成する．
          \begin{lstlisting}
# mysql -u root -p %\enter%
mysql> create database sales; %\enter%
mysql> use sales; %\enter%
mysql> create table sales ( %\enter%
    -> date text, %\enter%
    -> food text, %\enter%
    -> amount integer ); %\enter%
mysql> create table price ( %\enter%
    -> food text, %\enter%
    -> fee integer ); %\enter%
mysql> create table foodgroup ( %\enter%
    -> food text, %\enter%
    -> foodgroup text ); %\enter%
mysql> exit %\enter%
\end{lstlisting}
    \item \texttt{CSV}ファイルを読み込む．
          \begin{lstlisting}
# mysql -u root --local-infile=1 -p %\enter%
mysql> use sales; %\enter%
mysql> load data local infile "uriage-utf8.csv" into table sales fields terminated by ','; %\enter%
mysql> load data local infile "tanka-utf8.csv" into table price fields terminated by ','; %\enter%
mysql> load data local infile "bunrui-utf8.csv" into table foodgroup fields terminated by ','; %\enter%
\end{lstlisting}
\end{enumerate}
\subsection{データベースの操作}
\begin{enumerate}
    \item データベースにアクセスする．
          \begin{lstlisting}
# mysql -u root -p %\enter%
mysql> use sales; %\enter%
    \end{lstlisting}
    \item 2006/12/31 のサイダー2本を削除．
          \begin{lstlisting}
mysql> delete from sales.sales where sales.date='2006/12/31' and sales.food='サイダー'; %\enter%
\end{lstlisting}
    \item 2006/12/31 へオレンジジュース2本を追加．
          \begin{lstlisting}
mysql> insert into sales values ('2006/12/31', 'オレンジジュース', 2); %\enter%
\end{lstlisting}
    \item テーブル\texttt{sales}から2006/12/26に売り上げた食品の品目と個数を表示する（日付の表示はしない）．
          \begin{lstlisting}
mysql> select food,amount from sales where date='2006/12/26'; %\enter%
---
結果
---
\end{lstlisting}
    \item テーブル\texttt{sales}の食品名の横に，テーブル\texttt{foodgroup}の分類名を参照して，日付，食品名，分類，個数を表示する．
          \begin{lstlisting}
mysql> select sales.date, sales.food, foodgroup.foodgroup, sales.amount from sales,foodgroup where sales.food=foodgroup.food %\enter%
---
結果
---
\end{lstlisting}
    \item テーブル\texttt{sales}から，2006/12/30に売り上げたもののうち，麺でかつ単価が750円以上のものについて，売り上げ日，食品名，個数を表示する．
          \begin{lstlisting}
mysql> select date,sales.food,amount,foodgroup from sales,foodgroup,price where sales.food=foodgroup.food and sales.food=price.food and foodgroup.foodgroup='麺' and date='2006/12/31' and price.fee>=750; %\enter%
---
結果
---
\end{lstlisting}
\end{enumerate}
\end{document}